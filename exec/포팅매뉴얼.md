# Pookie 포팅 매뉴얼

## 목차
1. [프로젝트 개요](#프로젝트-개요)
2. [시스템 요구사항](#시스템-요구사항)
3. [환경 설정](#환경-설정)
4. [데이터베이스 설정](#데이터베이스-설정)
5. [백엔드 배포](#백엔드-배포)
6. [프론트엔드 배포](#프론트엔드-배포)
7. [AI 서비스 배포](#ai-서비스-배포)
8. [Docker 배포](#docker-배포)
9. [외부 서비스 설정](#외부-서비스-설정)
10. [배포 확인](#배포-확인)
11. [트러블슈팅](#트러블슈팅)

### 주요 구성 요소
- **Frontend**: React 19 + Vite 기반 웹 애플리케이션
- **Backend**: Spring Boot 3.5 REST API + WebSocket
- **AI Service**: FastAPI 기반 포즈 감지 서비스 (MediaPipe 사용)

## 시스템 요구사항

### 서버 환경
- **OS**: Ubuntu 20.04 LTS 이상
- **CPU**: 2 Core 이상
- **RAM**: 4GB 이상 (권장: 8GB)
- **Storage**: 20GB 이상
- **Network**: 인터넷 연결 필수

### 필수 소프트웨어
- **Java**: OpenJDK 17 이상
- **Node.js**: 18.x 이상
- **Python**: 3.8 이상
- **MySQL**: 8.0 이상
- **Docker**: 20.10 이상 (선택사항)
- **Nginx**: 1.18 이상 (프록시용)
- **LIVEKIT**: v3

## 환경 설정

### 1. Java 17 설치
```bash
sudo apt update
sudo apt install openjdk-17-jdk
java -version
```

### 2. Node.js 설치
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
node --version
npm --version
```

### 3. Python 3.8+ 설치
```bash
sudo apt update
sudo apt install python3 python3-pip
python3 --version
pip3 --version
```

### 4. MySQL 설치
```bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```

### 5. Nginx 설치
```bash
sudo apt update
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 6. LiveKit 설치
```bash
curl -sSL https://get.livekit.io/cli | bash
```

## 데이터베이스 설정

### 1. MySQL 데이터베이스 생성
```sql
-- MySQL 접속
sudo mysql -u root -p

-- 데이터베이스 생성
CREATE DATABASE pookie CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 사용자 생성 및 권한 부여
CREATE USER 'pookie_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON pookie.* TO 'pookie_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 초기 데이터 설정
백엔드 실행 시 `data.sql` 파일의 초기 데이터가 자동으로 로드됩니다.

## 백엔드 배포

### 1. 소스 코드 복사
```bash
cd /opt
sudo git clone [repository-url] pookie
cd pookie/backend
```

### 2. 환경 설정 파일 생성
```bash
# application.properties 수정
sudo nano src/main/resources/application.properties
```

#### 필수 설정 항목:
```properties
# 데이터베이스 설정
spring.datasource.url=jdbc:mysql://localhost:3306/pookie
spring.datasource.username=pookie_user
spring.datasource.password=your_password

# JWT 설정
jwt.secret=your-jwt-secret-key-here
jwt.access-token-expiration=3600000
jwt.refresh-token-expiration=604800000

# OAuth2 Kakao 설정
oauth2.kakao.client-id=your-kakao-client-id
oauth2.kakao.client-secret=your-kakao-client-secret
oauth2.kakao.redirect-uri=http://your-domain.com/api/auth/oauth2/callback/kakao

# LiveKit 설정
livekit.api-key=your-livekit-api-key
livekit.api-secret=your-livekit-api-secret
livekit.server-url=wss://your-livekit-server.com

# 서버 설정
server.port=8080
server.servlet.context-path=/api

# CORS 설정
cors.allowed-origins=http://localhost:3000,http://your-domain.com
```

### 3. 프로덕션 설정 파일
```bash
sudo nano src/main/resources/prod-application.properties
```

```properties
# 프로덕션 데이터베이스 설정
spring.datasource.url=jdbc:mysql://localhost:3306/pookie
spring.datasource.username=pookie_user
spring.datasource.password=your-production-password

# 로깅 설정
logging.level.com.ssafy.pookie=INFO
logging.file.name=logs/app.log
```

### 4. 애플리케이션 빌드 및 실행
```bash
# 권한 설정
chmod +x gradlew

# 빌드
./gradlew clean build

# JAR 파일 실행
java -jar -Dspring.profiles.active=prod build/libs/pookie-0.0.1-SNAPSHOT.jar
```

### 5. systemd 서비스 등록
```bash
sudo nano /etc/systemd/system/pookie-backend.service
```

```ini
[Unit]
Description=Pookie Backend Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/pookie/backend
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod build/libs/pookie-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable pookie-backend
sudo systemctl start pookie-backend
sudo systemctl status pookie-backend
```

## 프론트엔드 배포

### 1. 의존성 설치 및 빌드
```bash
cd /opt/pookie/frontend
npm install
```

### 2. 환경 변수 설정
```bash
# .env.production 파일 생성
nano .env.production
```

```env
VITE_API_BASE_URL=http://your-domain.com/api
VITE_SOCKET_URL=ws://your-domain.com/api/websocket
VITE_LIVEKIT_SERVER_URL=wss://your-livekit-server.com
```

### 3. 프로덕션 빌드
```bash
npm run build
```

### 4. Nginx 설정
```bash
sudo nano /etc/nginx/sites-available/pookie
```

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 정적 파일 서빙
    location / {
        root /opt/pookie/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 프록시
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # WebSocket 프록시
    location /api/websocket {
        proxy_pass http://localhost:8080/api/websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/pookie /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## AI 서비스 배포

### 1. Python 가상환경 설정
```bash
cd /opt/pookie/ai
python3 -m venv venv
source venv/bin/activate
```

### 2. 의존성 설치
```bash
pip install -r requirements.txt
```

### 3. AI 서비스 실행
```bash
python main.py
```

### 4. systemd 서비스 등록
```bash
sudo nano /etc/systemd/system/pookie-ai.service
```

```ini
[Unit]
Description=Pookie AI Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/pookie/ai
Environment=PATH=/opt/pookie/ai/venv/bin
ExecStart=/opt/pookie/ai/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable pookie-ai
sudo systemctl start pookie-ai
sudo systemctl status pookie-ai
```

### 5. Nginx AI 서비스 프록시 추가
```nginx
# /etc/nginx/sites-available/pookie 파일에 추가
location /ai/ {
    proxy_pass http://localhost:8000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## Docker base 배포

### 1. Docker Compose 설정
프로젝트 루트에 `docker-compose.yml` 생성:

```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: pookie
      MYSQL_USER: pookie_user
      MYSQL_PASSWORD: userpassword
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/pookie
      - SPRING_DATASOURCE_USERNAME=pookie_user
      - SPRING_DATASOURCE_PASSWORD=userpassword

  ai-service:
    build: ./ai
    ports:
      - "8000:8000"

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

### 2. Docker 실행
```bash
docker-compose up -d
```

## 외부 서비스 설정

### 1. Kakao OAuth2 설정
1. [Kakao Developers](https://developers.kakao.com/) 접속
2. 애플리케이션 생성
3. 플랫폼 설정에서 웹 도메인 등록
4. Redirect URI 설정: `http://your-domain.com/api/auth/oauth2/callback/kakao`
5. 동의항목에서 닉네임, 프로필 사진 설정

### 2. LiveKit 설정
1. [LiveKit Cloud](https://livekit.io/) 가입
2. 프로젝트 생성
3. API Key와 Secret 생성
4. 서버 URL 확인

## 배포 확인

### 1. 서비스 상태 확인
```bash
# 백엔드 서비스
sudo systemctl status pookie-backend

# AI 서비스
sudo systemctl status pookie-ai

# Nginx
sudo systemctl status nginx

# MySQL
sudo systemctl status mysql
```

### 2. 로그 확인
```bash
# 백엔드 로그
tail -f /opt/pookie/backend/logs/app.log

# Nginx 로그
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 3. 포트 확인
```bash
netstat -tlnp | grep -E "(80|8080|8000|3306)"
```

### 4. API 테스트
```bash
# 헬스체크
curl http://your-domain.com/api/actuator/health

# AI 서비스 테스트
curl http://your-domain.com/ai/health
```

## 트러블슈팅

### 1. 백엔드 서비스가 시작되지 않는 경우
```bash
# 로그 확인
journalctl -u pookie-backend -f

# 포트 충돌 확인
sudo lsof -i :8080

# 데이터베이스 연결 확인
mysql -u pookie_user -p pookie
```

### 2. 프론트엔드 빌드 실패
```bash
# Node.js 버전 확인
node --version

# 캐시 클리어
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### 3. AI 서비스 의존성 오류
```bash
# 가상환경 재생성
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 4. WebSocket 연결 실패
```bash
# Nginx 설정 확인
sudo nginx -t

# 방화벽 확인
sudo ufw status
sudo ufw allow 80
sudo ufw allow 8080
```

### 5. 메모리 부족
```bash
# 메모리 사용량 확인
free -h

# 스왑 파일 생성
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```
